# Журнал освоения фреймворка [Spec Kit](https://github.com/github/spec-kit)

## План освоения

- ☑ Создание конституции проекта
- ☑ Создание изолированного первого изменения в проекте через исполнение всех шагов последовательно
- ☑ Модернизация конституции проекта с учетом недостатков выявленных при создании первого изменения
- ☑ Создание изолированной второго изменения в проекте через исполнение всех шагов последовательно
- ☐ Модернизация конституции проекта с учетом недостатков выявленных при создании второго изменения
- ☐ Модернизация первой и второй изменений одновременно
- ☐ Подведение итогов

Версия:

- Spec Kit CLI: 0.0.22
- Spec Kit Template: 0.0.90
- Python: 3.14.0

## Журнал наблюдений

### 2025-12-02

#### 1df37ca60d4eee8e12d9f9e16e9055d876966c7b

Инициализировал проект через `specify init`, все прошло без конфликтов или ошибок.

#### 1cdb5c1731258ac35e053f4f1257d3dee7effbec

Создал конституцию проекта через `specify constitution`, в отличие от последующих команд промпт не был сохранен. Конституция была сохранена на русском языке, однако в ней не было создано требования о том, что все документы и комментарии должны быть написаны на русском языке.

#### 0d57dad06a299ba3888f1af38078976d4e0435e3

К сожалению, на данном этапе не догадался сохранять результат работы каждой команды в отдельном коммите (как и вести журнал), так что все изменения были сделаны в одном коммите.

По итогу README.md был обновлен согласно созданному функционалу, был создан полный пакет документов, работающий код и тесты - модульные и интеграционные. Поскольку в конституцию проекта не попало требование вести все документы и комментарии на русском языке, всё на английском.

✅ Плюсы:

- пользовательские промпты сохранены в файлах [спецификаций](specs/001-cbr-exchange-rate/spec.md), смотри заголовок
- проведено исследование особенностей внешних зависимостей (сайта ЦБ РФ, формата Parquet), данных, аргументированно выбраны библиотеки. Результаты сохранены в файл [research.md](specs/001-cbr-exchange-rate/research.md);
- подготовлена [спецификация на изменение](specs/001-cbr-exchange-rate/spec.md), содержащая пользовательские истории, граничные условия, требования, допущения и запланированные результаты;
- детально описаны контракты взаимодействия с [API ЦБ РФ](specs/001-cbr-exchange-rate/contracts/cbr-api-contract.md) и [командной строкой](specs/001-cbr-exchange-rate/contracts/cli-contract.md);
- детально описана [модель данных](specs/001-cbr-exchange-rate/data-model.md) со всеми нюансами и способами валидации;
- подготовлены детальные [план реализации](specs/001-cbr-exchange-rate/plan.md), учитывающий конституцию проекта и содержащий описание структуры проекта, и [техническое задание](specs/001-cbr-exchange-rate/quickstart.md) с детальным описанием всех компонент, их реализации, тестов, наиболее распространенных проблем и полезных ресурсов;
- подготовлены тесты, сделана реализация, тесты запущены, по результатам внесены изменения в реализацию, в итоге вся реализация работает корректно, данные извлекаются и сохраняются. Код достаточно хорошо структурирован, содержит описания модулей и функций, комментарии в коде. Описания классов и функций сделаны по одному шаблону, что упрощает читаемость.

❌ Минусы:

- пользовательские промпты не сохранены в файлах [плана](specs/001-cbr-exchange-rate/spec.md), хотя они приводятся для указаний особенностей технической реализации;
- [спецификации](specs/001-cbr-exchange-rate/spec.md) остаются в состоянии Draft даже после проверки и реализации, на официальном сайте нет информации как и когда должен изменяться статус;
- в [зависимости](requirements.txt) прописаны и установлены не последние стабильные версии библиотек;
- во большинстве md-файлов линтер выдает сообщения об ошибках - в основном из-за того, что между списками и предыдущим текстом, а также после заголовков нет пустов строки;
- во многих py-файлах линтер выдает сообщения об ошибках, есть неиспользуемые импорты, переменные, к которым нет обращений;
- нет реального E2E теста, все [интеграционные тесты](tests/integration/test_end_to_end.py) на заглушках;
- недостаточно уровней асбстракции и изоляции, методы слишком заточены под текущие задачи без перспектив расширения. Например, спецификация [cbr-api-contract.md](specs/001-cbr-exchange-rate/contracts/cbr-api-contract.md) с одной стороны, в названии не содержит уточнения, что это про сбор курсов валют, с другой стороны, в неё изначально вшит курс доллара к рублю, хотя курсов доступно великое множество и логичнее не конкретный курс указывать в контракте, а сделать общий контракт для конкретного сервиса, а валюты указывать при его использовании. Соответственно, в реализации детали тоже сразу вшиты. Реализация сохрания данных в parquet [parquet_writer.py](src/services/parquet_writer.py) названа логично, но слишком завязана на конкретную реализацию, при потребности использовать его для сохранения других данных придется полностью переписывать.

### 2025-12-04

#### 31e05c80286a529b6d9324ae001caf51e1ea3cd4

Обновил [конституцию проекта](.specify/memory/constitution.md) командой `/speckit.constitution`, указал, что для удобства работы команды все спецификации проекта и все комментарии в коде должны быть на русском языке.

Были внесены следующие изменения:

- обновлены метаданные конституции, а также указана причина изменения;
- добавлен новый принцип;
- обновлены все шаблоны документов.

При этом сами шаблоны переведеные не были.

#### 3070147217ea2c01f299b0ca5e1dd543ff5260fa

Добавлен GitHub workflow для использования линтера при push'е изменений. Запуск линтера сразу выявил множество проблем: Your code has been rated at 5.38/10.

#### 6137bce6fed314c9175397823aaeabf1cd0e3dd3

Сгенерирована [спецификация](specs/002-moscow-exchange-candles/spec.md) для второго изменения командой `/speckit.specify`. При генерации был предложен временной интервал в последние 30 дней, я попросил взять 7 последних дней по аналогии с существующим функционалом, модель об этом не догадалась. Изменение разбито на два пользовательских сценария, которые на самом деле являются частью одного. Сформирован реестр граничных условий и негативных сценариев, на часть прописана реакция по аналогии с существующим функионалом. Сформированы функциональные требования, описаны ключевые сущности, предположения и приемочные критерии.

> [!WARNING]
> Несмотря на явное указание в конституции проекта, а также в [шаблоне спецификации](.specify\templates\spec-template.md), значительная часть текста сгенерирована по-прежнему на английском

Сформирован файл [requirements.md](specs/002-moscow-exchange-candles/checklists/requirements.md), в котором перечислены все требования и проставлен их статус после окончания генерации. Все требования выполнены.

> [!WARNING]
> Файл полностью на английском!

#### 79847e6e54f87347f7346ff902e81bfd9e89a760

На основе спецификации сформирован [план реализации](specs/002-moscow-exchange-candles/plan.md) функционала командой `/speckit.plan`. Включает в себя:

- метаданные: когда создан, ссылка на спецификацию;
- технический контекст: версию Python и список библиотек;
- результаты сверки с конституцией проекта;
- структуру проекта: существующие и запланированные модули;
- высокоуровневый дизайн: детальный список модулей с нюансами реализации;
- стратегия тестирования: E2E и unit-тесты;
- фазы реализации: что в каком порядке делать.

> [!WARNING]
> По-прежнему все тесты на заглушках, нет тестов с реальным API! Хотя одно из требований содержит ограничение по времени получения ответа от API.

#### 8ae6ec70432b3745f8db4954ead8530fe0836c52

На основе плана сформирован список [задач для выполнения](specs/002-moscow-exchange-candles/tasks.md) и тестов, всё на русском. Используются фазы с предыдущего шага, часть задач маркирована как пригодных к одновременному выполнению для ускорения процесса.

> [!NOTE]
> Не знаю, как проверить одновременность выполнения задач, агент выполняет всё в одном окне как будто бы последовательно. Список задач не содержит даты создания.

### 2025-12-06

#### 8cbe43472297f719fa50f2beaf7ab6dcf41631a3

Командой `/speckit.analyze` проведен анализ подготовленных документов, по возникшим вопросам внесены следующие изменения:

- убраны метаданные для XLSX-файла, решил ограничиться записью в имя файла интервала времени и даты формирования отчета;
- указаны детали обработки оставшихся негативных сценариев;
- добавлены требования по локализации, вытекающие из конституции проекта;
- добавлен тест на проверку времени выполнения сценария.

#### 5f60c112aff2ff0f72d6c6d18f5108bf218bd401

Командой `/speckit.implement` проведено [исследование](specs/002-moscow-exchange-candles/research.md) API перед реализацией. Документация дополнена описаниями [контрактов](specs/002-moscow-exchange-candles/contracts/) и [модели данных](specs/002-moscow-exchange-candles/data-model.md). Подготовлено [краткое описание](specs/002-moscow-exchange-candles/quickstart.md) использования изменения.

Реализовано изменение по спецификации:

- Создана [модель данных](src/models/candles.py) `CandleRecord` для представления дневных свеч OHLCV;
- Разработан [класс](src/services/moex_client.py) `MoexClient` для получения ежедневных свечей через ISS API, включены проверка данных и обработчики ошибок;
- Разработан [класс](src/services/xlsx_writer.py) для сохранения данных по свечам в формате XLSX, имя файла формируется по указанному шаблону;
- Дополнены вспомогательные функции;
- Подготовлены модульные и интеграционные тесты.

> [!WARNING]
>
> - Тесты для первого изменения `001-cbr-exchange-rate` были сломаны и не исправлены;
> - Так и не был сделан интеграционный тест на взаимодействие с реальной платформой;
> - Несмотря на то, что тесты были созданы и успешно пройдены, функционал сохранения данных в файл не сработал, ошибок в консоли тоже не видно;
> - Тесты не изолированы, хотя изменения реализуют не связанный функционал. Было бы удобнее иметь возможность хотя бы запускать тесты для разного функционала независимо, будь то разделение по папкам/файлам или при помощи метеданных;
> - В соответствии со спецификацией реализация слишком слеплена, нехватает изоляции для дополнения в будущем: например, не запись в XLSX, как и ранее в parquet, тесно связана со структурой конкретного набора данных, хотя можно было бы делать через Pandas Dataframe, как более универсальное решение;
> - Часть импортов не используется.

<!-- -->

> [!CAUTION]
> По завершении работы модель выдала сообщение **Next steps: Complete Phase 6 tasks (README/quickstart sync, log/message audit, perf benchmark).**, на что я не обратил внимание, вследствие этого указанная часть задач не была выполнена.

### 2025-12-07

#### 220520b664bcc33e03d4e1c01fb93a92d7b025d0

Вручную добавил пустые строки после заголовков и вокруг список. Запросил проверку качества имплементации кода согласно [конституции проекта](.specify/memory/constitution.md). По итогам проверки были:

- переведены новые докстринги на русский: src/services/moex_client.py, src/models/candles.py, src/services/xlsx_writer.py;
- ужесточена проверка boardid в MoexClient: теперь колонка обязательна, валидируется, и нет молчаливой подстановки;
- успешно проведены все 58 тестов!
- предложено локализовать оставшиеся английские докстринги/комментарии в других новых файлах.

> [!NOTE]
> Как выяснилось позже, именно ужесточение проверки boardid в MoexClient сломало функционал загрузки свечей, так как API не отдает boardid :)

#### ca8f5993b7612dfd388cea8eebcd79262950e6ea

Запросил локализовать оставшиеся английские докстринги/комментарии во всех файлах папок src и tests, в итоге:

- Переведены комментарии и строки документации на русский язык в `main.py`, `candles.py`, `exchange_rate.py`, `cbr_client.py`, `moex_client.py`, `parquet_writer.py`, `xlsx_writer.py`, `date_utils.py`, и `validators.py`.
- Обновлены сообщения логирования и ошибки для лучшего понимания пользователями.
- Уточнены атрибуты и описание моделей данных для `CandleRecord` и `ExchangeRateRecord` на русском языке.
- Обновлены тесты для проверки корректности работы с локализованными сообщениями.

> [!NOTE]
> Побочный эффект - сообщение коммита теперь на русском. Посмотрим, насколько его хватит.

### 2025-12-08

#### TBD

Починил сбор данных с МосБиржи: "При ошибках MoexClient не выдает сообщения в консоль, а молча заканчивает работу, что не позволяет идентифицировать проблему.":

- В src/cli/main.py при ошибках MoexClient теперь печатается сообщение в stderr перед возвратом кода выхода.
- Добавлен безопасный разбор аргументов: при вызове из тестов или без явных аргументов игнорируются pytest-пути, а при реальном вызове из CLI используется переданный argv (или sys.argv[1:]).
- Регрессия: pytest tests/integration/test_end_to_end.py tests/unit/test_moex_client.py — все 11 тестов проходят.

Теперь при сбоях MoexClient пользователь увидит причину в консоли, а тесты/CLI работают штатно.

> [!NOTE]
> Непонятно, откуда взялся безопасный разбор документов, этого я не просил.

<!-- -->

> [!CAUTION]
> Крайне странное исправление в [moex_client.py](src\services\moex_client.py) довольно спорного изначально решения, линтеры для проверки кода не прогонялись:

```python
    board = (
        row[col_index["boardid"]]
        if "boardid" in col_index
        else self.EXPECTED_BOARD
    )

    record = CandleRecord(
        date=day,
        open=parse_float(row[col_index["open"]]),
        high=parse_float(row[col_index["high"]]),
        low=parse_float(row[col_index["low"]]),
        close=parse_float(row[col_index["close"]]),
        volume=parse_float(row[col_index["volume"]]),
        instrument=self.INSTRUMENT,
        board=self.EXPECTED_BOARD,
    )
    records_by_date[day] = record
```

Явно нужно пройтись линтером по всем файлам и исправить ошибки.

> [!TIP]
> Генератор commit messages продолжает писать на русском, чудеса.
