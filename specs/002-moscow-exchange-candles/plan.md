# Implementation Plan: Extract Daily Candles for LQDT from Moscow Exchange

**Branch**: `002-moscow-exchange-candles` | **Date**: 2025-12-04 | **Spec**: [spec.md](./spec.md)  
**Input**: Feature specification from `/specs/002-moscow-exchange-candles/spec.md`

> **Примечание**: Согласно конституции проекта, все планы и спецификации должны быть написаны на русском языке.

## Summary

Инструмент командной строки должен извлекать дневные свечи (OHLCV: Date, Open, High, Low, Close, Volume) для инструмента LQDT с доски TQTF через публичный API Московской биржи за последние 7 календарных дней и сохранять результат в локальный XLSX‑файл.  
План предполагает максимальное переиспользование уже существующей структуры и подходов из фичи `001-cbr-exchange-rate`: общая CLI‑точка входа, отдельный сервис‑клиент для внешнего API, утилиты для работы с датами, слой валидации данных и отдельный модуль для записи файла (аналог `ParquetWriter`, но для XLSX).

## Technical Context

**Language/Version**: Python 3.14  
**Primary Dependencies**:

- `requests` — HTTP‑клиент (уже используется в `CBRClient`);  
- `openpyxl` или `xlsxwriter` — библиотека для записи XLSX (будет добавлена в зависимости);  
- `datetime` (stdlib) — работа с датами;  
- `logging` (stdlib) — логирование;  
- `pytest` — тестирование (уже используется в проекте).

**Storage**: XLSX‑файлы в локальной файловой системе (текущая рабочая директория).  
**Testing**: `pytest` + мокирование HTTP‑запросов (`requests` session) и файловой системы.  
**Target Platform**: кросс‑платформенный CLI‑инструмент (Windows / Linux / macOS).  
**Project Type**: single (CLI‑приложение) с уже заданной структурой `src/` + `tests/`.  
**Performance Goals**: завершать запрос свечей и запись XLSX за ≤ 20 секунд при нормальных сетевых условиях (SC‑001).  
**Constraints**:

- Запрашивать только последние 7 календарных дней;  
- Обрабатывать сетевые ошибки и ошибки API без падений, с понятными сообщениями и кодами выхода;  
- Всегда сохранять файл в текущую рабочую директорию, не перезаписывая предыдущие файлы (уникальное имя по периоду и времени запуска).  
**Scale/Scope**: один инструмент CLI, обрабатывающий до нескольких десятков строк OHLCV за запуск (7 дней по одному инструменту).

## Constitution Check

### Principle 1: Code Quality

- ✅ **PASS**: Структура кода повторяет проверенный паттерн из фичи 001 — отдельные слои `services`, `utils`, `cli`, `models`.
- ✅ **PASS**: Именование и стиль следуют PEP 8; новые модули будут согласованы с уже существующими (`moex_client.py`, `xlsx_writer.py`).
- ✅ **PASS**: Функции будут малые и одноответственные (запрос данных, преобразование/валидация, запись файла, CLI‑обёртка).

### Principle 2: Repeatability

- ✅ **PASS**: Для фиксированного периода (последние 7 дней на момент запуска) и стабильного API результат детерминирован (одинаковый ввод → одинаковый вывод).  
- ✅ **PASS**: Зависимости описаны в `requirements.txt`.  
- ✅ **PASS**: Имена файлов включают период и временную метку, что предотвращает перезапись и позволяет воспроизводить разные прогоны.

### Principle 3: Testing Standards

- ✅ **PASS**: Используется общий для проекта фреймворк `pytest`.  
- ✅ **PASS**: Юнит‑тесты будут изолированы за счёт мокирования HTTP‑клиента и файловой системы.  
- ✅ **PASS**: Интеграционный тест повторяет поток CBR‑фичи (от CLI до файла), но с моками API Мосбиржи.

### Principle 4: Business Function Coverage

- ✅ **PASS**: Покрываем тестами извлечение свечей, построение периода из 7 дней, поведение при отсутствии данных и ошибки API.  
- ✅ **PASS**: Запись XLSX‑файла и его структура будут проверяться тестами.  
- ✅ **PASS**: Ошибки и валидация данных будут иметь отдельные тесты.

### Principle 5: Documentation

- ✅ **PASS**: `spec.md` и `plan.md` описывают *что* и *почему*;  
- ✅ **PASS**: README будет расширен кратким описанием новой команды/режима при необходимости;  
- ✅ **PASS**: В коде будут комментарии для нетривиальной логики (например, соответствие полей API колонкам XLSX).

**GATE STATUS**: ✅ **PASS** — все принципы удовлетворены, можно переходить к детализации реализации.

## Project Structure

### Documentation (this feature)

```text
specs/002-moscow-exchange-candles/
├── plan.md              # Этот файл (/speckit.plan вывод)
├── spec.md              # Спецификация фичи
├── data-model.md        # Будет заполнен при детализации сущностей (Phase 1)
├── quickstart.md        # Краткое руководство по запуску (Phase 1)
├── research.md          # Исследование API Мосбиржи и форматов (Phase 0)
├── contracts/           # Контракты: Moex API, CLI (Phase 1)
└── tasks.md             # Список задач (создаётся отдельной командой `/speckit.tasks`)
```

### Source Code (repository root)

Переиспользуем существующую структуру фичи 001, добавляя минимальный набор новых модулей.

```text
src/
├── models/
│   ├── exchange_rate.py          # Уже существует, может быть примером стиля моделей
│   └── candles.py                # [Optional] Модель CandleRecord для OHLCV (если потребуется отдельный тип)
├── services/
│   ├── cbr_client.py             # Уже существует (пример клиента внешнего API)
│   ├── parquet_writer.py         # Уже существует (пример слоя записи)
│   ├── moex_client.py            # Новый клиент API Мосбиржи для свечей LQDT/TQTF
│   └── xlsx_writer.py            # Новый модуль записи XLSX с колонками Date, Open, High, Low, Close, Volume
├── cli/
│   └── main.py                   # Существующий CLI; будет расширен режимом для свечей LQDT/TQTF
└── utils/
    ├── date_utils.py             # Уже существует (get_last_7_days используется повторно)
    └── validators.py             # Уже существует; будет расширен проверками для OHLCV

tests/
├── unit/
│   ├── test_cbr_client.py
│   ├── test_parquet_writer.py
│   ├── test_validators.py
│   ├── test_date_utils.py
│   ├── test_moex_client.py       # Новый: юнит‑тесты клиента Мосбиржи (моки HTTP)
│   └── test_xlsx_writer.py       # Новый: юнит‑тесты записи XLSX
└── integration/
    └── test_end_to_end.py        # Уже существует; будет дополнен сценарием LQDT/TQTF→XLSX
```

**Structure Decision**: сохраняем единый проект (один CLI), расширяя его новой функциональностью по паттерну уже реализованной CBR‑фичи: отдельный клиент внешнего API, отдельный writer и минимальные изменения в CLI.

## High-Level Design

1. **Расчёт периода (7 дней)**:  
   - Переиспользуем `get_last_7_days()` из `src/utils/date_utils.py` для расчёта периода `[today-6, ..., today]`.  
   - В CLI для свечей берём `start_date = dates[0]`, `end_date = dates[-1]` по аналогии с CBR CLI.

2. **Клиент API Мосбиржи (`moex_client.py`)**:  
   - Класс `MoexClient` со схожей структурой и обработкой ошибок, как `CBRClient`:  
     - Использует `requests.Session`;  
     - Имеет константы `BASE_URL`, параметры доски `TQTF` и инструмента `LQDT`;  
     - Метод `get_daily_candles(start_date: date, end_date: date) -> list[CandleRecord]`.  
   - Логика:  
     - Формирует HTTP‑запрос к публичному ISS‑API Мосбиржи для дневных свечей LQDT на доске TQTF и периоде `start_date..end_date`;  
     - Обрабатывает коды ошибок HTTP, сетевые таймауты, отсутствие инструмента/данных;  
     - Преобразует ответ API в список записей с полями Date, Open, High, Low, Close, Volume;  
     - Возвращает одну запись на день в целевом периоде, заполняя отсутствующие дни `None` для всех числовых полей (в соответствии со спецификацией о NULL).

3. **Модель данных свечей**:  
   - Добавить `CandleRecord` в `src/models/candles.py` с полями:
     - `date: date`, `open: float | None`, `high: float | None`, `low: float | None`, `close: float | None`, `volume: float | None`, `instrument: str`, `board: str`.  

4. **Валидация данных (`validators.py`)**:  
   - Добавить функцию `validate_candles(records, start_date, end_date) -> tuple[bool, str | None]` по аналогии с существующей `validate_records`:
     - Проверка, что список записей покрывает все 7 дат (даже если значения NULL);  
     - Проверка типов и допустимости числовых полей, когда они присутствуют (например, цены и объём неотрицательны);  
     - Возврат `(True, None)` при успехе или `(False, "описание ошибки")` при проблемах.

5. **Запись XLSX (`xlsx_writer.py`)**:  
   - Класс `XLSXWriter` по аналогии с `ParquetWriter`, но:
     - Использует `openpyxl`/`xlsxwriter` для создания книги и листа;  
     - Создаёт заголовок с колонками `Date, Open, High, Low, Close, Volume`;  
     - Записывает одну строку на каждый день периода (7 строк), с `None` → пустая ячейка;  
     - Формирует имя файла по шаблону:  
       `lqdt_tqtf_{period_start}_to_{period_end}_{report_date}_{HHMMSS}.xlsx`.  
   - Обрабатывает ошибки записи (нет прав, диск заполнен и т.п.), бросая `IOError` по аналогии с `ParquetWriter`.

6. **CLI‑слой (`cli/main.py`)**:  
   - Расширить существующую функцию `main()`, добавив **подкоманды** для однозначного разделения сценариев CBR и LQDT/TQTF, не ломая уже реализованный сценарий CBR:  
     - Подкоманда `cbr` — текущий режим извлечения курса RUB/USD из ЦБ РФ (поведение по умолчанию может вызываться как `python -m src.cli.main cbr`);  
     - Подкоманда `moex-lqdt` — новый режим извлечения дневных свечей LQDT/TQTF (`python -m src.cli.main moex-lqdt`).  
   - Реализация подкоманд через `argparse` subparsers внутри существующего `main()` позволяет избежать неоднозначностей флагов и сохранить единый вход CLI.  
   - Логика в режиме LQDT/TQTF:
     1. Вычислить период через `get_last_7_days()`;  
     2. Вызвать `MoexClient().get_daily_candles(start_date, end_date)`;  
     3. Провести валидацию `validate_candles(...)`;  
     4. Подготовить метаданные: `report_date`, `period_start`, `period_end`, `data_source="MOEX-ISS"`, `instrument="LQDT"`, `board="TQTF"`;  
     5. Записать файл через `XLSXWriter().write_candles(records, metadata, output_dir=".")`;  
     6. Обработать ошибки и вернуть соответствующие коды выхода (можно переиспользовать те же константы или добавить отдельные для MOEX, сохранив семантику).

7. **Коды выхода**:  
   - Переиспользовать существующие коды, где семантика совпадает:
     - `0` — успех;  
     - `1` — ошибка внешнего API (в данном случае API Мосбиржи);  
     - `2` — сетевой таймаут/ошибка подключения;  
     - `3` — некорректные/повреждённые данные от API;  
     - `4` — ошибка ФС;  
     - `5` — ошибка валидации данных.  
   - Внутри кода для LQDT/TQTF использовать аналогичное разветвление по тексту ошибок, как сейчас делает CLI для CBR.

## Testing Strategy

1. **Unit tests**:
   - `test_moex_client.py`:
     - Мокаем `requests.Session.get` для успешного ответа с примером структуры свечей и проверяем корректное маппирование в `CandleRecord`/структуру;  
     - Тестируем случаи отсутствия данных по дню (должен возвращаться `None`/NULL в полях);  
     - Проверяем обработки HTTP‑ошибок, таймаута, недоступности API, ситуации «инструмент не найден».  
   - `test_xlsx_writer.py`:
     - Тест успешной записи файла с 7 строками и корректными заголовками;  
     - Проверка, что NULL‑значения приводят к пустым ячейкам;  
     - Проверка формата имени файла (период, дата, время).  
   - Расширение `test_validators.py`:
     - Тесты для `validate_candles`: корректный список за 7 дней, пропуски, отрицательные цены/объёмы и т.п.

2. **Integration tests (`tests/integration/test_end_to_end.py`)**:
   - Добавить сценарий по аналогии с уже существующим end‑to‑end тестом для CBR:
     - Мокаем `MoexClient` или HTTP‑слой таким образом, чтобы CLI работал с предсказуемыми данными;  
     - Запускаем CLI с подкомандой `moex-lqdt`;  
     - Проверяем:  
       - код выхода 0;  
       - наличие созданного XLSX‑файла с именем по шаблону;  
       - корректное количество строк и колонок.

3. **Negative/edge tests**:
   - Нет данных за часть периода → файл создаётся, недостающие дни имеют NULL;  
   - Инструмент/доска не найдены → код ошибки ≠ 0, понятное сообщение;  
   - Ошибка записи файла → код 4, сообщение в stderr.

## Implementation Phases

1. **Phase 0 — Research (research.md)**:
   - Зафиксировать выбранный эндпоинт ISS‑API Мосбиржи для свечей LQDT/TQTF, параметры запроса и формат ответа (JSON/XML).  
   - Описать маппинг полей ответа API в целевые поля `Date, Open, High, Low, Close, Volume`.

2. **Phase 1 — Design (data-model.md, contracts/, quickstart.md)**:
   - Описать модель `CandleRecord` (если используется);  
   - Оформить Moex API contract (аналог `cbr-api-contract.md`): URL, параметры, примеры ответов, ошибки;  
   - Описать CLI‑контракт для нового режима (аргументы, коды выхода, примеры запуска);  
   - Подготовить `quickstart.md` с примерами использования для LQDT/TQTF.

3. **Phase 2 — Implementation**:
   - Реализация `moex_client.py`, `xlsx_writer.py`, расширение `validators.py` и `cli/main.py`;  
   - Добавление/обновление зависимостей (`requirements.txt`);  
   - Реализация и настройка юнит‑тестов.

4. **Phase 3 — Integration & Polish**:
   - Добавление/обновление интеграционных тестов;  
   - Проверка соответствия спецификации (`spec.md`) и кода;  
   - Финальный проход по логам/сообщениям об ошибках на предмет понятности.

## Complexity Tracking

На текущий момент нарушений конституции по сложности нет: фича реализуется в рамках уже принятой архитектуры (один CLI, сервисы, утилиты, writer‑слой) и повторяет успешно обкатанный подход из фичи `001-cbr-exchange-rate`.
